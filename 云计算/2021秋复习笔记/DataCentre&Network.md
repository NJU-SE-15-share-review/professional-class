# 云数据中心

## 概论

### 回顾

云计算流程：物理机器→虚拟机→资源管理和分配→用户或代理商

- 服务请求监控；

  分析请求是否符合`QoS (Quality of Service)`要求，判断是否会导致资源超载、资源是否有限等问题

- 定价和计费；

- 虚拟机监控器和分配器；

### 特征

#### 高设备利用率

- 通过虚拟化技术（==服务器虚拟化==、==存储虚拟化==、==网络虚拟化==、==应用虚拟化==）将云平台系统与数据中心硬件资源整合，达到减少物理服务器数量的目标；

  > 最后一个貌似之前没有提？

- 优化资源利用率、简化管理，降低成本、快速响应业务需求的变化等；；

- 较大的数据中心有更低的单位运营成本：==网络==、==存储==、==管理；==

  大型数据中心（几十万台到上百万台）VS 小型数据中心（千台）：成本大概`7:1`到`5:1`；

#### 绿色节能

> - 服务器本身：节能服务器、节能存储设备、刀片服务器；
>
> - 环境：供电技术、散热技术，降低能耗；
>
> - 软件：虚拟机等资源调度算法、计算任务管理算法等；

##### 为什么要绿色节能？

- 云计算数据中心很耗电；
- 目前对大型云计算而言，能耗成本已经直逼硬件成本，要想节约成本显然应从能耗下手；
- 保护环境生态环境与可持续发展的需要；

##### 配电系统节能

高压直流配电技术、市电直供配电技术……

##### 空调系统节能

低能耗加湿系统、自然冷空调系统……（`EER`（制冷量/制冷电能耗））

##### 集装箱数据中心节能技术

模块化

##### 管理系统节能策略和算法

动态/静态功率管理（`DPM`/`SPM`）、`DVFS`，开启关闭

##### 新能源应用

利用新能源/把服务器放到特定的地方。`Power usage effectiveness (PUE)`

#### 高可用性

- 各个部分的冗余、容错、容灾设计；

- 扩展和升级时，保持正常运行（比如说实时迁移）；

##### 容灾备份

###### 定义

容灾备份是通过在异地建立和维护一个备份存储系统，利用地理上的分离来保证系统和数据对灾难性事件的抵御能力。

| 数据级容灾                                                   | 应用级容灾                                                   |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 数据级容灾只保证数据的完整性、可靠性和安全性，但提供实时服务的请求在灾难中会中断。 | 应用级容灾系统能够提供不间断的应用服务，让服务请求能够透明地继续运行，保证数据中心提供的服务完整、可靠、安全。 |
| **数据恢复点目标**                                           | **恢复时间目标**                                             |
| Recovery Point Objective，RPO                                | Recovery Time Objective，RTO                                 |
| 主要指业务系统所能容忍的数据丢失量                           | 主要指所能容忍的业务停止服务的最长时间                       |

###### 关键技术

核心：==复制数据==

- 远程镜像
- 快照
- 基于IP的SAN的远程数据容灾备份技术
- 数据库复制技术

#### 自动化管理

- 无人值守，远程管理（系统漏洞与补丁管理、性能管理和瓶颈分析、服务器与操作系统部署、系统功率测量和调整）

- 门禁、通风、温度、湿度、电力均可远程调度与控制

> UPS、空调/新风系统/CRAC、高热密度服务器

使得在规模较大的情况下，实现较少人员对数据中心的高度智能管理。

##### 工作范围

按需分配和收回服务器、存储、网络、应用程序

##### 具体内容

资源的自动化调度和对业务的灵活响应，即需要单个业务能自治管理，也需要一个负责全局控制和协调的中心，对业务和资源进行统一监控、管理和调度。

##### 五个特征

- 全面的可视性
- 自动的控制执行
- 多层次的无缝集成
- 综合与实时的报告
- 全生命周期支持——自动化整个“计划—实施—检查—更正”的IT流程生命周期

##### 三个阶段

IT服务操作→IT服务管理→数据中心自动化

##### 必备条件

- 管理系统
- 定义过程
- 认知非自动化过程的成本（防止为了自动化而自动化）
- 内部流程资源

## 网络

### 指标

低成本、高可扩展性、低配置开销、健壮性、节能

![image-20211007165852052](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211007165852052.png)

### 传统树状网络

- 建造方便简单

- 不便于拓展与升级

- 任意一个核心交换机故障导致上千台服务器失效

### 改进树：`FatTree`

#### 计算

1. $K$叉树，$K$个`Pod`(集装器)，每个`Pod`有$K$个交换机，其中$K/2$个接入交换机，$K/2$个汇聚交换机。

2. `Pod`中每个交换机有$K$个接口，接入层$K/2$个接主机，$K/2$个接汇聚；汇聚层$K/2$个接接入，$K/2$个接核心。

3. 有个核心交换机，每个交换机$K$个端口接$K$个汇聚交换机。有$K^3 /4$台主机。

4. 一个`Pod`内的所有交换机相互连接成==完全二分图==（汇聚和接入二分）。

5. 一个`Pod`内的每个汇聚交换机与一部分核心交换机连接，但是一个`Pod`和每一个核心交换机都有连接。

6. 任意两个不同`Pod`之间存在$K$条路径。

   > 此项存疑。YDJSIR认为是$(K/2)^2$。但目前所有能找到的中文资料都认为是$K$。课件上也是$K$。YDJSIR认为课堂上`lcy`老师的解释有问题，只是因为$K=4，K/2=2$恰巧没问题而已。

#### 特征

- 两级路由表，允许两级前缀查询：Pod间流量尽可能均匀分布于核心交换机；与现有数据中心网络使用的以太网结构和IP 配置的服务器兼容；
- 任意两个不同`Pod`主机之间存在多条路径，将流量在这些路径间分散，为内部节点间通信提供多条并行链路；任意给定`Pod`的低层和高层交换机对位于本`Pod`的任意子网都有终结性表项；在全负载最坏的情况下实现约$87\%$的聚合带宽；
- 消除了树形结构上层链路对吞吐量的限制；
- 横向扩展的尝试降低了构建数据中心网络的成本；
- ==受限于核心交换机端口数量==

#### 示例

##### $K=4$

![image-20211007171242995](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211007171242995.png)

##### $K=6$

![image-20211007171406307](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211007171406307.png)

> 画得快自闭了……

### 改进树：VL2

#### 计算

1. 若干服务器（一般是20）连接到机架（接入）交换机。

2. 每台接入交换机与==两==台汇聚交换机连接。

3. 每台汇聚交换机与==所有==核心交换机连接。

#### 特征

VL2是一套可扩展且很灵活的网络架构，微软数据中心采用。用多个==小规模、低成本==的单元，构建==复杂、大规模==的网络。

核心思想：使用CLOS拓扑结构建立扁平的第二层网络。

> CLOS是什么？反正是个三层的架构，课上没讲，资料显示`FatTree`也用了。
>
> 参考资料：https://en.wikipedia.org/wiki/Clos_network

应用程序使用服务地址通信而底层网络使用位置信息地址进行转发，使得虚拟机能够**在网络中任意迁移而不影响服务质量**。

- 在VL2中，IP地址仅仅作为名字使用，没有拓扑含义。

- VL2的寻址机制将服务器的名字与其位置分开。

- VL2使用可扩展、可靠的目录系统来维持名字和位置间的映射。

- 当服务器发送分组时，服务器上的VL2代理开启目录系统以得到实际的目的位置，然后将分组发送到目的地。

##### 优点

VL2是目前最易用于对现有数据中心网络改造的结构。

##### 缺点

VL2依赖于中心化的基础设施来实现2层语义和资源整合，面临==单点失效==和==扩展性==问题。

#### 示例

> 上课举的例子里面，没有要求汇聚交换机上行和下行的端口数目相同。

![image-20211007171921746](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211007171921746.png)

### 递归层次网络概述

解决可扩展性的较好选择。

- 最小递归单元的结构；

- 递归规律；

每一个高层的网络拓扑，由多个低层的递归单元按照递归规律相互连接构成，同时也是更高层级网络的一个递归单元。

- 增加服务器数量==>提高总的递归层次；
- 添加服务器更加灵活，可增加的数量增大；
- 对交换机性能要求低。

### 递归层次：`DCell`

#### 计算

1. 第0层就是让所使用的交换机接满主机，假设有$K_0$台主机。

2. N层网络要求主机至少有N+1个网络接口。

3. 增加一层时，若当前网络有$K_n$台主机，则需要增加$K_n1$个n层网络组成下一级网络，能增加${K_n}^2$台主机容量，使得整个网络的主机容量达到$K_n(K_n + 1)$。设这里采用的交换机有$m$个端口，那么我们有

$$
K_0 = m，K_{n+1}= {K_n(K_n + 1)}\\
$$

   这个数字也等于交换机数量乘以交换机端口数量。因为0层以上的连接都是服务器之间的连接。

#### 特征

- **可扩展性好**

- **拓扑层数受限于服务器端口数**

#### 示例

![image-20211007172838631](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211007172838631.png)

第一层勉强能画

![image-20211007223248803](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211007223248803.png)

第二层的只好画两口的情况（这也太难画了）

![image-20211007223125038](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211007223125038.png)

### 递归层次：`FiConn`

#### 计算

1. 第$0$层为基本构建单元，$n$个服务器连接一个具有$n$个端口的交换机。

2. 每个低层`FiConn`中备用端口空闲的==一半==服务器与其他==相同==层次的`FiConn`网络中备用端口空闲的服务器连接，一半预留给高层网络。

3. $k$层服务器、$k$层端口、$k$层链路。假设当前层有$K_n$个主机，那么除了第0层网络，其他层数网络中均有$K_n / 2$个主机有空闲端口。这些空闲端口中又有一半要留给更高层的网络，那么和同级网络组网构成高一级网络时需要$K_n/4$个同级的网络，也即增加${K_n}^2 /4$台主机容量，达到$\frac {K_n(K_n + 4)}{4}$的容量。设这里的交换机有$m$个端口即

$$
K_0 = m，K_1 = m^2 / 2 + m，  K_{n+1}=\frac {K_n(K_n + 4)}{4}(n>1)
$$

   这个数字也等于交换机数量乘以交换机端口数量。因为0层以上的连接都是服务器之间的连接。

#### 特征

- **不需要对服务器和交换机做修改**（服务器上找两个网口不难）；
- 对外连接的链路有限，容错较弱，链路路径长度大，路由效率不高；

#### 示例

![image-20211007200037345](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211007200037345.png)

在这里把2层`FiConn`画了一下。

![image-20211007212947668](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211007212947668.png)

### 递归层次：`BCube`

#### 计算

1. 设交换机n个端口，服务器k+1个端口

2. 第$0$层：$n$服务器连接$1$个0层交换机

   第$1$层：$n$个$n0$层，每个$n0$层的每个主机各自连接一个交换机，$n$个$n0$层共连接$n$个1层交换机

   ……

   第$k$层：$n$个$k-1$层连接$n^k$个$k$层交换机，容纳$n^{k+1}$ 台主机。此时网络已无法容纳更多的主机。

#### 特征

- 没有明显的瓶颈链路，出现故障时性能优雅下降，服务可用性高

- 服务器间路径多，探测的通信和计算开销大

- 硬件要求特殊：端口数目

#### 示例

![image-20211007234848083](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211007234848083.png)

### 光交换网络

业务越来越庞大和复杂，数据中心内部和服务器间的数据流量快速增加，传统网络设备无法处理如此流量的数据——考虑可光速传播数据的设备，需要调整网络拓扑。

#### `Helios`：混合电/光结构网络

- 两层多根树

- 服务器连接接入交换机

- 接入交换机连接电交换和光交换网络

![image-20211007235452548](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211007235452548.png)

#### `OSA` (`Optical Switching Architecture`)基于光交换的数据中心网络体系结构

- 光交换矩阵(`OSM`, `Optical Switching Matrix`)

  任意输入端口可以连接到任意输出端口

- 波长选择交换机(`WSS`， `Wavelength Selective Switch`)

  将从通用端口进入的波长集和分开在N个波长端口

![image-20211007235540789](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211007235540789.png)

- 更高的传输效率；

- 更灵活的拓扑结构；
- 更低的制冷成本；

### 无线数据中心网络

- 静态链路和有线接口在大量高突发流量和高负载服务器情况下降低数据中心网络性能；

- 无线网络的广播机制克服这个问题；

- `Flyways`：在过热的交换机间添加无线链路；使用贪心算法将最大流量链路分摊到其他可行路径；

- `WDCN`异构的以太网/无线体系结构；

![image-20211007235746106](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211007235746106.png)

- 无需重新布线即可灵活调整拓扑结构；
- 提供足够带宽的前提下传输距离有限；

### **软件定义网络（`SDN`）**

#### 定义

将网络的==控制平面==和==数据转发平面==分离。

#### 结构

![image-20211008104536264](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211008104536264.png)

| 层级       | 说明                                                         |
| ---------- | ------------------------------------------------------------ |
| 基础设施层 | 底层转发设备，根据控制器设定的规则进行数据分组的转发。       |
| 控制器层   | 即`SDN`控制软件，维护网络状态，向底层提供控制和数据平面接口用于获取底层基础设施信息，<br>向应用层提供可扩展的接口。 |
| 应用程序层 | 略                                                           |

#### 特征

- 通过软件更新实现网络升级，无需针对硬件进行配置；

- 数据转发与网络控制解耦，简化底层网络设备功能；
- 使得网络具备集中协调点；
- 加快网络部署周期并加速网络创新周期；

#### 实例：`Openflow`

`Openflow`，第一个针对SDN实现的标准接口。

灵活性与规范性。

起源于斯坦福`Clean Slate`计划。

![image-20211008124902795](https://oss.ydjsir.com.cn/GitPages/CloudComputing/DataCentreNetwork.assets/image-20211008124902795.png)