# `OpenStack`

## 概论

### 定义

`OpenStack`是开源云计算平台，可控制整个数据中心的大型计算，存储和网络资源池。

用户能够通过`Web界面`、`命令行`或`API接口`配置资源。

![image-20211010080049370](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010080049370.png)

> 这张图下面的英文原文就是第一第二句话的英文版……

### 特性

- 自身不提供虚拟化技术；
- 调用多种技术实现多资源池管理；
- 对外提供统一管理接口；
- 环境隔离，资源复用；
- 降低隔离损耗，提升运行效率；
- 提供高级虚拟化特性；

定位：云计算操作系统：云计算的==控制面==

![image-20211010080215829](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010080215829.png)

- `OSS`: `Operations Support System`；

- `BSS`: `Business Support System`；

### 小结

`OpenStack`既是一个社区，也是一个项目和一个开源软件，提供了一个部署云的操作平台或工具集。用`OpenStack`易于构建虚拟计算或存储服务的云，既可以为公有云、私有云，也可以为大云、小云提供可扩展、灵活的云计算。

`OpenStack`是一个管理==计算== - 如``Nova``、==存储== - 如`Swift`、 和==网络== - 如``Neutron``资源的数据中心云计算开放平台，通过一个仪表板，为管理员提供了所有的管理控制，同时通过Web界面为其用户提供资源。

![image-20211010080731853](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010080731853.png)

## 架构概述

### 组件简介

#### 最初核心

- `Nova`：管理虚拟机
- `Swift`：用标准的硬件进行PB级的安全、可靠的==对象存储==
- `Glance`：管理镜像

#### 其他组件

- `Keystone`：认证管理服务，用户或服务的验证或授权

- `Cinder`：块存储服务

- `Manila`：文件共享存储服务

- `Neutron`：网络服务，提供网络即服务的功能

- `Telemetry`：计量服务，计量租户资源使用率
- `Heat`：编排服务，面向`OpenStack`开发者
- `Horizon`：仪表盘服务，无状态无数据的web应用
- 消息队列（如`RabbitMQ`）：中心化的消息交换器
- 数据库（如下图的`Trove`）：构建时和运行时状态信息



![image-20211010084947432](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010084947432.png)

#### ==概念模型==

![image-20211026202416554](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211026202416554.png)

![image-20211010093418210](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010093418210.png)

| **功能类别** | **角色**                   |              |
| ------------ | -------------------------- | ------------ |
| 计算         | 存储虚拟机镜像             | 提供用户接口 |
| 镜像         | 存储磁盘文件               | 提供用户接口 |
| 对象存储     | 存储对象                   | 提供用户接口 |
| 块存储       | 提供卷                     | 提供用户接口 |
| 网络         | 提供网络连接               | 提供用户接口 |
| 计量         | 提供度量、指标和报警       | 提供用户接口 |
| 文件共享     | 提供横向扩展的文件共享系统 | 提供用户接口 |
| 编排         | 为堆栈创建提供编排引擎     | 提供用户接口 |
| 身份认证     | 提供认证                   |              |
| 仪表盘       | 提供图形化用户界面         |              |

#### 文件存储、对象存储与块存储

> 参考资料：https://www.redhat.com/zh/topics/data-storage/file-block-object-storage

##### 文件存储

以文件和文件夹的==层次结构==来整理和呈现数据。

- 路径查找，简明快捷
- 纵向拓展困难（得添置更多系统搞横向）

##### 块存储

会将数据拆分到任意划分且大小相同的==卷==中。

- 适合大量数据情形，灵活
- ==将数据与用户环境分离==
- 块存储的成本高昂
- 处理元数据的能力有限；这意味着，它需要在应用或数据库级别进行处理

##### 对象存储

会管理数据并==将其链接至关联的元数据==。

- 对象存储经济高效，您只需为已用的内容付费
- 轻松扩展，因而是公共云存储的理想之选。
- 非常适用于静态数据的存储
- 灵活性和扁平性
- 擅长存储非结构化数据
- 无法修改对象 — 您必须一次性完整地写入对象

- 对象存储也不能很好地与传统数据库搭配使用

### 虚拟机的创建

#### 资源准备

- 通过`Keystone`进行用户身份认证，通过认证后，用户即可与`OpenStack` API节点通信，触发创建请求；

- 通过调度器获得启动虚拟机的最佳位置：通过工作守护进程获得物理节点上的资源状态；``Nova`-scheduler`；

#### 创建流程

- 调用身份认证进行身份验证

- 生成用于后续调用的令牌

- 访问镜像服务以获取镜像列表，并获取目标基础镜像

- 处理计算服务API请求

- 处理计算服务对安全组和密钥调用的请求

- 调用网络服务API确定可用网络

- 通过计算节点调度程序选择`Hypervisor`节点

- 调用块存储服务API为实例分配卷

- 通过计算服务API调用再`Hypervisor`节点启动实例

- 调用网络服务API为实例分配网络资源

传统上这些流程基本都要和`Keystone`交互以鉴权，这些令牌生成与验证的过程带来性能问题，所以要采用加密身份验证方法（公钥-私钥，类似HTTPS）来减轻`Keystone`的压力。

### 架构设计

#### 四种节点

控制、网络、计算、存储

![image-20211010092953676](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010092953676.png)

#### ==逻辑模型==设计

控制节点中封装了大量的`OpenStack`的服务。

![image-20211026202233458](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211026202233458.png)

> 这个图答题时代表性应该更强一些

![image-20211010090137952](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010090137952.png)

#### 存储设计

有哪些数据需要存储？虚拟机快照备份的存储要求是什么？需要文件共享系统吗？是否需要虚拟机之间实现存储共享？

#### 网络设计

网络服务是`OpenStack`服务中最复杂的。

- 使用隔离的物理网络处理不同类型的网络流量；

- 租户数据网络：为租户创建的虚拟网络提供物理路径；

- 管理和API网络：`OpenStack`服务之间的通信，可细分；

- 存储网络：虚拟机和存储节点之间的物理连接；

##### 虚拟网络类型

- 外部网络：全局互联并使用可路由的IP寻址；`SNAT`虚拟机访问外网；`DNAT`外网访问虚拟机；

- 租户网络：虚拟机之间专用网络；私有IP空间；租户流量隔离；

#### 估算

##### CPU评估

逻辑CPU数：物理CPU*核数*超线程数；一个逻辑CPU对应一个虚拟CPU；一个虚拟CPU支持多个虚拟机【影响性能；可以使用频数计算】；一个虚拟机可以使用多个虚拟CPU，但不能多于逻辑CPU数；

可以超额分配，但是不能超额执行；超分：**单台物理机中虚拟机个数＊频数>物理频数**

##### 内存评估

单台物理机虚拟机个数*虚拟机最大动态分配内存+主机内存用量。

##### 网络评估

网卡带宽>单个虚拟机带宽*虚拟机个数；公共IP地址个数；浮动IP地址个数。

##### 存储评估

虚拟机的临时存储+永久存储；存储节点的对象存储、块存储和文件共享存储。

##### 最佳实践

分析需求、考虑需求增长情况、持续跟踪每一个服务单元、丢弃和替换服务单元；按需调整。

#### ==物理模型==

![image-20211010090446149](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010090446149.png)

- 五种节点：部署各个系统的不同组件

  除了控制、计算、存储、网络，图中还多了个`Util`，这里一般是数据库等通用组件。可以看到`Util`不仅走公网与控制和网络节点相连，还走内网和所有其他四种类型的网络相连。

  不难发现计算节点连外网是通过虚拟机流量网络先到网络节点再出去的。

- 三层网络：不同的使用目的；`OpenStack`内部网络、外部网络、虚机网络。

## 部署

### +DevOps

让研发（`Development`）和运维（`Operations`）一体化，让团队从业务需求出发，向着同一个目标前进。

`DevOps`（`Development`和`Operations`的组合）是一组过程、方法与系统的统称，用于促进开发（应用程序/软件工程）、技术运营和质量保障（`QA`）部门之间的沟通、协作与整合。

- 简化和模块化`OpenStack`服务；像开发构建模块一样开发`OpenStack`服务；

- 在不影响整个系统的情况下，促进服务的定制和改进；

- 使用正确的工具来构建服务，确保服务在相同输入情况下输出相同结果；

- 将服务愿景从如何做切换到要做什么；

### 工具

**`Ansible`**：一定程度上的自动化部署。

> 环境构建、开发机初始化、安装Git、执行引导程序仍需要手动完成

## 节点详解：控制节点

### 集群：提供高可用性

两台或多台服务器的能力聚合就是服务器集群，通过堆积机器即可实现这种聚合。

- 向上扩展（垂直扩展）：向服务器添加更多的CPU和内存；

- 向下扩展（水平扩展）：增加更多的标准商用服务器；

### 非对称集群

备服务器只有在主服务器发生故障时才接管系统，处于高可用目的，包含故障切换配置。

### 对称集群

所有节点都是活动的，共享工作负载，可视为负载均衡集群。

`OpenStack`的功能被广泛分布到多个服务中，包含了基础架构服务和`OpenStack`服务

### 基础架构服务

不属于`OpenStack`对外提供的公共服务，但被多个`OpenStack`组件使用。

#### 消息队列

必须是集群式的；`RabbitMQ`，`ZeroMQ`，`Qpid`。

#### 整合数据库

`OpenStack`的环境数据，使用数据等；`MySQL`和`MongoDB`。

### `OpenStack`服务

身份、镜像、计算、网络、存储等

### `Keystone`：认证服务

身份认证和服务目录（所有其他服务需向`Keystone`注册API端点）

由多个`Provider`组成。

- 身份提供者`Identity` `Provider`：服务用户、管理员用户、终端用户；

- 资源提供者`Resource` `Provider`： `project`、`domain`；

- 认证提供者`Authorization` `Provider`：用户和用户组和他们角色之间的关系；

- 令牌提供者`Token` `Provider`：访问`OpenStack`服务需要一个有效的令牌，通过身份提供者的认证后获得令牌；

- 目录提供者`Catalog` `Provider`：维护服务和API端点的目录

- 策略提供者`Policy` `Provider`：策略由多条规则组成，每条规则定义了哪些用户和角色被允许访问哪些资源；

### `Nova`==管理组件及API==

#### 权责范围

##### 负责

- 虚拟机生命周期管理

- 其他计算资源的生命周期管理

##### 不负责

- 承载虚拟机的物理机自身的管理

- 全面的系统状态监控

#### 运行在云控制器上的组件

##### `Nova-api`

云控制器中的编排引擎；通过API将消息写入数据库和消息队列向其他守护进程传递消息。

##### `Nova-conductor`

代表计算节点上`Nova`-compute执行数据库操作，提供数据库访问隔离；将来自计算节点请求并行化。

##### `Nova-scheduler`

专门的调度算法；确定虚拟机创建的最佳放置位置；支持过滤器检查计算节点上资源可用性，通过加权机制过滤出计算节点列表，再确定启动虚拟机的最佳位置；支持自定义度量标准和策略考量配置。

在生产环境下，配置单独的存储主机，其调度器运行在存储主机上。

##### ==`Nova-compute`运行在计算节点上==

##### `Nova-network`

可以被`Neutron`替代，网络API驻留在云控制器中，独立配置网络服务器节点。

##### `Glance`

==镜像管理==

- `Glance` API提供外部REST接口，用于查询虚拟机镜像及相关元数据

- `Glance` registry将镜像元数据存储在数据库中，并==利用存储后端实际存储镜像==

- 例如使用`Swift`对象存储作为镜像存储后端

##### 仪表盘服务

运行在`Apache Web`服务器后端，可以将其运行在可以访问API端点的单独节点上，降低云控制器负载。

##### 计量服务

跟踪资源使用情况，计算资源利用率。

多种使用目的：计费、容量规划、按需求和吞吐量的虚拟基础架构自动扩展等。

#### API服务

类似`Nova-api`，也将身份、镜像、网络和存储API都放在云控制器上运行

#### 特征

- 无中心结构

- 节点无本地状态

- 多控制器：请求聚合+负载均衡

- 水平可扩展：控制节点、计算节点

|                                                              |                                                              |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| ![image-20211010094715897](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010094715897.png) | ![image-20211010094723895](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010094723895.png) |

## 节点详解：计算节点

### `Hypervisor`

计算节点运行==`Nova`-compute==服务，负责启动和终止虚拟机，通过==消息总线==监听虚拟机相关请求。

`OpenStack`中虚拟机管理程序能够支持各种`VMM`以及`Docker`。

![image-20211010095423614](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010095423614.png)

#### `Nova Docker`

类似虚拟机实例启动和管理容器生命周期，然而一个应用或服务往往需要容器组构建。

### `Magnum`

- 使用容器编排引擎(`COE`)管理连接着的容器组

- `COE`节点部署为`Nova`实例

- `Bay`是一组运行`COE`软件的节点，表示一个容器集群

  `Pod`是`COE`最基本的部署调度单元，逻辑上对应一个服务实例，运行一组容器，必须有一个作为网络路由

  ![image-20211010095507147](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010095507147.png)

### 相关概念

![image-20211010095535677](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010095535677.png)

- `Region`：地理区域

- `Availability Zone`：对某个地理区域的用户而言的可用区域

- `Host Aggregate`：按照类型将物理主机放到一起组成区域

- `Host`：具体的物理主机

> 各大公有云一般是同地理区域内都是内网直通的。

![image-20211010095658676](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010095658676.png)

> 除了`HA`和`Service`，其他概念其实都挺好找的。

### `Nova`单元

按照计算节点为最小单位的管理视角——`Nova`单元。

所有计算节点都需要与消息总线和数据库服务器通信，随着计算节点增多，使得消息队列和数据库过载，因此产生`Nova`计算单元。

- 由多个计算节点组成一个单元

- `API`单元：作为树根，使用基于消息队列的`RPC`调用和计算节点交互

- 计算单元：每个单元有自己的消息队列和数据库

![image-20211010095854690](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010095854690.png)

## 节点详解：存储节点

### `Cinder`

为云平台提供统一接口，按需分配的，持久化的==块存储==服务。

核心功能是对卷的管理，允许对==卷==、卷的类型、卷的快照、卷备份进行操作

为后端不同的存储设备提供了统一的接口，不同的块设备服务厂商在``Cinder``中实现其驱动支持以与``OpenStack``进行整合。

![image-20211010100114078](https://oss.ydjsir.com.cn/GitPages/CloudComputing/OpenStack.assets/image-20211010100114078.png)

## 节点详解：网络节点

使得运营商能够构建和管理具有所有必要元素的完整网络拓扑。

提供网络、子网、路由器、负载均衡器、防火墙和端口。

==API服务器==运行在==云控制器==上。

### 基于插件的架构

- API服务将请求转发到特定插件，插件通过代理和设备交互或者控制资源

- 提供了基于开源技术的插件和代理参考实现

- 网络节点提供资源实现网络服务：路由、防火墙、负载均衡器和`VPN`

- 核心插件：创建和管理网络、端口和子网

- 服务插件：实现高阶网络服务，路由、防火墙等

- 代理：部署在计算和网络节点上，通过消息总线上的`RPC`和服务器交互

- - `L2`代理：运行在计算和网络基点上，将虚拟机和网络设备连接到二层网络上
  - `DHCP`代理、`L3`代理和`VPN`代理

  比如说基于`VLAN`或其他隧道。

## 拓展

- `OpenStack`的高可用和容错机制；

- `OpenStack`集群监控和故障排查；

- `OpenStack` ELK日志处理系统；

- `OpenStack`基准测试和性能调优；